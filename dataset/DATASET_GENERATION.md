# Dataset Generation Report

## Overview

This document describes the process used to generate the RAVEN dataset samples.

## Generation Command

```bash
python src/dataset/main.py --num-samples 50 --save-dir ./dataset --seed 42
```

## Parameters Used

| Parameter | Value | Description |
|-----------|-------|-------------|
| `--num-samples` | 50 | Number of samples per configuration |
| `--save-dir` | `./dataset` | Output directory |
| `--seed` | 42 | Random seed for reproducibility |

## Dataset Statistics

- **Total Samples**: 350 (50 samples x 7 configurations)
- **Files per Sample**: 2 (one .npz, one .xml)
- **Total Files**: 700

### Samples per Configuration

| Configuration | Samples | Train | Val | Test |
|--------------|---------|-------|-----|------|
| center_single | 50 | 30 | 10 | 10 |
| distribute_four | 50 | 30 | 10 | 10 |
| distribute_nine | 50 | 30 | 10 | 10 |
| left_center_single_right_center_single | 50 | 30 | 10 | 10 |
| up_center_single_down_center_single | 50 | 30 | 10 | 10 |
| in_center_single_out_center_single | 50 | 30 | 10 | 10 |
| in_distribute_four_out_center_single | 50 | 30 | 10 | 10 |

## Solver Accuracy

The built-in solver achieved **100% accuracy** on all configurations, verifying that all generated puzzles have valid solutions.

## File Format

### NPZ Files

Each `.npz` file contains:
- `image`: (16, 160, 160) uint8 array - 8 context panels + 8 answer choices
- `target`: int - Correct answer index (0-7)
- `predict`: int - Solver's prediction (should match target)
- `meta_matrix`: (8, 9) uint8 array - Rule encoding matrix
- `meta_target`: (9,) uint8 array - Bitwise-OR of meta_matrix rows
- `structure`: str - Serialized tree structure
- `meta_structure`: (21,) uint8 array - Structure encoding

### XML Files

Each `.xml` file contains detailed annotations:
- Panel decomposition (Struct -> Component -> Layout -> Entity)
- Entity attributes with value indices (Type, Size, Color, Angle)
- Bounding boxes (original and real)
- RLE-encoded masks
- Rule groups with names and attributes

## Generation Process

1. **Tree Construction**: For each configuration, an And-Or Tree (AoT) is built representing the grammatical structure of the puzzle.

2. **Rule Sampling**: Rules are randomly sampled for each component:
   - Number/Position rules (Constant, Progression, Arithmetic, Distribute_Three)
   - Type rules (Constant, Progression, Distribute_Three)
   - Size rules (Constant, Progression, Arithmetic, Distribute_Three)
   - Color rules (Constant, Progression, Arithmetic, Distribute_Three)

3. **Constraint Pruning**: The AoT is pruned to satisfy all rule constraints.

4. **Panel Generation**:
   - Row 1: Initial configuration sampled, rules applied to generate 3 panels
   - Row 2: Rules applied across rows
   - Row 3: Rules applied to generate context panels and answer

5. **Answer Generation**:
   - Correct answer derived from rule application
   - 7 wrong answers generated by modifying attributes

6. **Rendering**: Each panel is rendered as a 160x160 grayscale image using OpenCV.

7. **Serialization**: Data saved as NPZ (numpy) and XML (annotations).

## Python 3 Compatibility

This dataset was generated using Python 3.11.14. The codebase was refactored from Python 2 to Python 3 with the following changes:

- `scipy.misc.comb` -> `scipy.special.comb`
- Integer division `/` -> `//` where needed
- `print` statements -> `print()` functions
- `dict.keys()` wrapped in `list()` for compatibility
- `range()` wrapped in `list()` where list operations are needed
- XML serialization uses `encoding='unicode'`
- Binary mask generation fixed for RLE encoding

## Reproducibility

Using the same seed (42) and parameters will produce identical results. The random number generators used are:
- `random.seed(42)`
- `numpy.random.seed(42)`

## Directory Structure

```
dataset/
├── DATASET_GENERATION.md          # This file
├── center_single/
│   ├── RAVEN_0_train.npz
│   ├── RAVEN_0_train.xml
│   └── ... (100 files total)
├── distribute_four/
│   └── ... (100 files)
├── distribute_nine/
│   └── ... (100 files)
├── left_center_single_right_center_single/
│   └── ... (100 files)
├── up_center_single_down_center_single/
│   └── ... (100 files)
├── in_center_single_out_center_single/
│   └── ... (100 files)
└── in_distribute_four_out_center_single/
    └── ... (100 files)
```
